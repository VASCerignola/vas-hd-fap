<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VAS-HD (FAP)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c86a9a">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
:root{
 --bg:#120b10;--card:#1b0f17;--line:#6b2b4a;
 --txt:#f2e9ee;--mut:#d6b3c4;--accent:#c86a9a;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui;background:var(--bg);color:var(--txt)}
.hidden{display:none}

/* BACKGROUND */
.step-bg{position:relative;min-height:100vh;background-size:cover;background-position:center}
.step-bg::before{content:"";position:absolute;inset:0;background:rgba(18,11,16,.75)}
.step-bg>*{position:relative;z-index:1}
.bg-nurse{background-image:url('bg-nurse.jpg')}
.bg-patient{background-image:url('bg-patient.jpg')}
.bg-access{background-image:url('bg-access.jpg')}
.bg-checklist{background-image:url('bg-checklist.jpg')}
.bg-result{background-image:url('bg-result.jpg')}

/* UI */
header{padding:14px;border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
small{color:var(--mut)}
main{padding:14px;max-width:980px;margin:auto}
.card{border:1px solid var(--line);border-radius:16px;padding:14px;background:rgba(27,15,23,.95);margin-bottom:14px}
label{font-size:12px;color:var(--mut);display:block;margin:14px 0 6px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f0a0d;color:var(--txt)}
.row{display:flex;gap:10px;margin-top:14px}
.btn,.btn2{width:100%;padding:14px;border-radius:14px;font-weight:900}
.btn{border:0;background:var(--accent);color:white}
.btn2{border:1px solid var(--line);background:transparent;color:var(--txt)}
.btn:disabled{opacity:.45}

.badge{display:inline-block;padding:10px 14px;border-radius:999px;font-weight:900;color:white}
.g0{background:#3b7d5b}.g1{background:#b58b2a}.g2{background:#c46a2d}.g3{background:#b11226}

.alert{margin-top:12px;padding:12px;border-radius:12px;font-weight:900}
.alert.red{background:#b11226}

.history{display:flex;flex-direction:column;gap:10px}
.hitem{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(15,10,13,.55)}
.hmeta{color:var(--mut);font-weight:800;font-size:12px}
.hmain{font-weight:900}
</style>
</head>

<body>

<div id="splash" onclick="enterApp()">
  <img src="splash.png" style="max-width:100%">
</div>

<div id="app" class="hidden">

<header>
  <h1>VAS-HD (FAP)</h1>
  <small>Sorveglianza accessi vascolari â€“ allarmi + Qb</small>
</header>

<!-- HOME -->
<main id="home">
  <div class="card">
    <div class="hmain">ðŸ“‹ Storico sedute</div>
    <div class="row">
      <button class="btn2" onclick="exportCSV()">ðŸ“¤ Excel</button>
      <button class="btn2" onclick="shareCSV()">ðŸŸ¢ WhatsApp</button>
    </div>
    <div id="history" class="history" style="margin-top:12px"></div>
  </div>
  <button class="btn" onclick="startWizard()">âž• Nuova seduta</button>
</main>

<!-- STEP 1 -->
<section id="s1" class="hidden step-bg bg-nurse"><main>
<div class="card">
<label>Infermiere</label><input id="nurse">
<button class="btn" onclick="next1()">Avanti</button>
</div></main></section>

<!-- STEP 2 -->
<section id="s2" class="hidden step-bg bg-patient"><main>
<div class="card">
<label>ID Paziente</label><input id="pid" placeholder="GR72">
<button class="btn" onclick="next2()">Avanti</button>
</div></main></section>

<!-- STEP 3 -->
<section id="s3" class="hidden step-bg bg-access"><main>
<div class="card">
<label>Accesso</label>
<select id="accesso">
<option value="">â€”</option>
<option>FAV</option>
<option>AVG</option>
<option>CVC</option>
</select>
<button class="btn" onclick="next3()">Avanti</button>
</div></main></section>

<!-- STEP 4 -->
<section id="s4" class="hidden step-bg bg-checklist"><main>
<div class="card">

<label>Qb ottenuto</label>
<select id="qb">
<option value="">â€”</option>
<option value="ok">â‰¥95%</option>
<option value="mid">85â€“94%</option>
<option value="low">&lt;85%</option>
</select>

<label>Allarmi ripetuti</label>
<select id="alarm">
<option value="">â€”</option>
<option value="no">No</option>
<option value="single">SÃ¬, intermittenti</option>
<option value="many">SÃ¬, frequenti</option>
</select>

<label>Note cliniche (opzionale)</label>
<select id="note">
<option value="">â€”</option>
<option>Cannulazione difficile</option>
<option>Sanguinamento prolungato</option>
<option>Thrill ridotto/assente</option>
<option>Segni locali sospetti</option>
</select>

<button class="btn" onclick="calc()">Calcola</button>
</div></main></section>

<!-- STEP 5 -->
<section id="s5" class="hidden step-bg bg-result"><main>
<div class="card">
<div id="result"></div>
<div id="action"></div>

<div id="medBlock" class="alert red hidden">
Medico informato?
<select id="medicoInf">
<option value="">â€”</option>
<option value="si">SÃ¬</option>
</select>
</div>

<button class="btn" onclick="finish()">Fine</button>
</div></main></section>

</div>

<script>
const STATE={}, STORE="VAS_HD";

function enterApp(){splash.style.display="none";app.classList.remove("hidden");renderHistory()}
function startWizard(){home.classList.add("hidden");go("s1")}
function go(id){document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden")}

function next1(){if(!nurse.value)return alert("Infermiere");STATE.nurse=nurse.value;go("s2")}
function next2(){if(!pid.value)return alert("Paziente");STATE.pid=pid.value;go("s3")}
function next3(){if(!accesso.value)return alert("Accesso");STATE.accesso=accesso.value;go("s4")}

let LAST={grade:0,summary:""};

function calc(){
 let g=0;
 let f=[];
 if(qb.value==="low"){g=2;f.push("Qb<85")}
 if(qb.value==="mid"){g=Math.max(g,1);f.push("Qb85â€“94")}
 if(alarm.value==="many"){g=Math.max(g,2);f.push("allarmi frequenti")}
 if(alarm.value==="single"){g=Math.max(g,1);f.push("allarmi intermittenti")}
 if(qb.value==="low" && alarm.value==="many"){g=3}
 if(note.value) f.push(note.value)

 LAST.grade=g;
 LAST.summary=f.join(", ")||"â€”";

 render();
 go("s5");
}

function render(){
 const t=["G0 Routine","G1 Warning","G2 Disfunzione probabile","G3 Critico"];
 result.innerHTML=`<span class="badge g${LAST.grade}">${t[LAST.grade]}</span><div>${LAST.summary}</div>`;
 action.innerHTML=(LAST.grade<2)
  ? "Sorveglianza"
  : "Informare medico";
 medBlock.classList.toggle("hidden",LAST.grade<2);
}

function finish(){
 if(LAST.grade>=2 && medicoInf.value!=="si") return alert("Informare medico");
 save();
 go("home");
}

function save(){
 const a=JSON.parse(localStorage.getItem(STORE)||"[]");
 a.unshift({d:new Date().toISOString(),...STATE,g:LAST.grade,s:LAST.summary});
 localStorage.setItem(STORE,JSON.stringify(a));
 renderHistory();
}

function renderHistory(){
 const a=JSON.parse(localStorage.getItem(STORE)||"[]");
 history.innerHTML=a.map(r=>`<div class="hitem"><div class="hmain">${r.pid} Â· ${r.accesso} Â· G${r.g}</div><div class="hmeta">${r.s}</div></div>`).join("")||"<div class='hmeta'>Nessuna seduta</div>";
}

function exportCSV(){
 const a=JSON.parse(localStorage.getItem(STORE)||"[]");
 if(!a.length)return;
 const csv=["Data;Inf;Paz;Accesso;G;Note",...a.map(r=>`${r.d};${r.nurse};${r.pid};${r.accesso};G${r.g};${r.s}`)].join("\n");
 const b=new Blob([csv]);const x=document.createElement("a");x.href=URL.createObjectURL(b);x.download="VAS-HD.csv";x.click();
}

async function shareCSV(){
 exportCSV();
}
</script>
</body>
</html>
