<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VAS-HD (FAP)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c86a9a">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
:root{
  --bg:#120b10;
  --card:#1b0f17;
  --line:#6b2b4a;
  --txt:#f2e9ee;
  --mut:#d6b3c4;
  --accent:#c86a9a;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui;background:var(--bg);color:var(--txt)}
.hidden{display:none}

/* ===== BACKGROUND STEP ===== */
.step-bg{
  position:relative;
  min-height:100vh;
  background-size:cover;
  background-position:center;
}
.step-bg::before{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(18,11,16,0.75);
}
.step-bg > *{position:relative;z-index:1}

.bg-nurse{background-image:url('bg-nurse.jpg')}
.bg-patient{background-image:url('bg-patient.jpg')}
.bg-access{background-image:url('bg-access.jpg')}
.bg-checklist{background-image:url('bg-checklist.jpg')}
.bg-result{background-image:url('bg-result.jpg')}

/* ===== SPLASH ===== */
#splash{
  position:fixed;inset:0;
  background:#120b10;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#splash img{max-width:100%;max-height:100%;object-fit:contain}

/* ===== UI ===== */
header{padding:14px;border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
small{color:var(--mut)}
main{padding:14px;max-width:900px;margin:auto}

.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:rgba(27,15,23,.95);
  margin-bottom:14px;
}

label{font-size:12px;color:var(--mut);display:block;margin:14px 0 6px}
input,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#0f0a0d;
  color:var(--txt)
}

.row{display:flex;gap:10px;margin-top:14px}
.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  background:var(--accent);
  color:white
}
.btn2{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:transparent;
  color:var(--txt);
  font-weight:900
}

.stepTitle{font-weight:900;font-size:16px}
.stepSub{color:var(--mut);margin-top:4px}

.badge{display:inline-block;padding:10px 14px;border-radius:999px;font-weight:900;color:white}
.g0{background:#3b7d5b}
.g1{background:#b58b2a}
.g2{background:#c46a2d}
.g3{background:#b11226}

.alert{margin-top:12px;padding:12px;border-radius:12px;font-weight:900}
.alert.red{background:#b11226}

.progress{margin-top:10px;color:var(--mut);font-weight:800}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash" onclick="enterApp()">
  <img src="splash.png" alt="VAS-HD">
</div>

<div id="app" class="hidden">

<header>
  <h1>VAS-HD (FAP)</h1>
  <small>ü©∏ Sorveglianza accessi vascolari ‚Äì wizard a cascata</small>
</header>

<!-- HOME -->
<main id="home">
  <div class="card">
    <div class="stepTitle">üìã Avvio</div>
    <div class="stepSub">Wizard guidato: Infermiere ‚Üí Paziente ‚Üí Accesso ‚Üí Checklist ‚Üí Grading.</div>
  </div>
  <button class="btn" onclick="startWizard()">‚ûï NUOVA SEDUTA</button>
</main>

<!-- STEP 1 -->
<section id="s1" class="hidden step-bg bg-nurse">
<main>
  <div class="card">
    <div class="stepTitle">üßë‚Äç‚öïÔ∏è Identificazione infermiere</div>
    <div class="stepSub">Firma o sigla per tracciabilit√†.</div>
    <label>Firma</label>
    <input id="nurse" placeholder="Es. M.R. / Maria Rossi">
    <div class="row">
      <button class="btn2" onclick="goHome()">‚Ü© Esci</button>
      <button class="btn" onclick="next1()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 2 -->
<section id="s2" class="hidden step-bg bg-patient">
<main>
  <div class="card">
    <div class="stepTitle">üßæ Identificazione paziente</div>
    <div class="stepSub">Inserisci ID (es. GR72).</div>
    <label>ID paziente</label>
    <input id="pid" placeholder="Es. GR72">
    <div class="row">
      <button class="btn2" onclick="go('s1')">‚¨Ö Indietro</button>
      <button class="btn" onclick="next2()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 3 -->
<section id="s3" class="hidden step-bg bg-access">
<main>
  <div class="card">
    <div class="stepTitle">ü©∏ Tipo di accesso</div>
    <div class="stepSub">La checklist successiva cambia in base all‚Äôaccesso.</div>
    <label>Accesso</label>
    <select id="accesso">
      <option value="">‚Äî seleziona ‚Äî</option>
      <option value="FAV">FAV</option>
      <option value="AVG">AVG</option>
      <option value="CVC">CVC</option>
    </select>
    <div class="row">
      <button class="btn2" onclick="go('s2')">‚¨Ö Indietro</button>
      <button class="btn" onclick="next3()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 4 -->
<section id="s4" class="hidden step-bg bg-checklist">
<main>
  <div class="card">
    <div class="stepTitle">üîç Sorveglianza dell‚Äôaccesso vascolare</div>
    <div class="stepSub">Compila una voce per volta: la cascata segue l‚Äôaccesso selezionato.</div>

    <!-- FLOW FAV/AVG -->
    <div id="flowAV" class="hidden">
      <div class="progress" id="progAV">Progress: 0/5</div>

      <div id="av1">
        <label>1) Puntura</label>
        <select id="av_puntura">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option>Facile</option>
          <option>Difficile</option>
          <option>Impossibile</option>
        </select>
      </div>

      <div id="av2" class="hidden">
        <label>2) Thrill</label>
        <select id="av_thrill">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option>Normale</option>
          <option>Ridotto</option>
          <option>Assente</option>
        </select>
      </div>

      <div id="av3" class="hidden">
        <label>3) Bruit</label>
        <select id="av_bruit">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option>Normale</option>
          <option>Alto-pitch</option>
          <option>Assente</option>
        </select>
      </div>

      <div id="av4" class="hidden">
        <label>4) Qb ottenuto rispetto al prescritto</label>
        <select id="av_qb">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">‚â• 95%</option>
          <option value="moderato">85‚Äì94%</option>
          <option value="basso">&lt; 85%</option>
        </select>
      </div>

      <div id="av5" class="hidden">
        <label>5) Allarmi ripetuti</label>
        <select id="av_allarmi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="arteriosi">Arteriosi</option>
          <option value="venosi">Venosi</option>
          <option value="entrambi">Entrambi</option>
        </select>
      </div>
    </div>

    <!-- FLOW CVC -->
    <div id="flowCVC" class="hidden">
      <div class="progress" id="progCVC">Progress: 0/5</div>

      <div id="cvc1">
        <label>1) Aspirazione/flussaggio dei lumi</label>
        <select id="cvc_lumi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">OK entrambi</option>
          <option value="uno">Problema 1 lume</option>
          <option value="due">Problema entrambi</option>
        </select>
      </div>

      <div id="cvc2" class="hidden">
        <label>2) Inversione linee necessaria</label>
        <select id="cvc_inversione">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>

      <div id="cvc3" class="hidden">
        <label>3) Qb ottenuto rispetto al prescritto</label>
        <select id="cvc_qb">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">‚â• 95%</option>
          <option value="moderato">85‚Äì94%</option>
          <option value="basso">&lt; 85%</option>
        </select>
      </div>

      <div id="cvc4" class="hidden">
        <label>4) Allarmi ripetuti</label>
        <select id="cvc_allarmi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>

      <div id="cvc5" class="hidden">
        <label>5) Exit-site / infezione</label>
        <select id="cvc_exit">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">OK</option>
          <option value="rosso">Arrossato</option>
          <option value="essudato">Essudato</option>
        </select>

        <label style="margin-top:12px">Febbre</label>
        <select id="cvc_febbre">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>
    </div>

    <div class="row">
      <button class="btn2" onclick="go('s3')">‚¨Ö Indietro</button>
      <button class="btn" onclick="calc()">Calcola ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 5 -->
<section id="s5" class="hidden step-bg bg-result">
<main>
  <div class="card">
    <div class="stepTitle">üìä Grading</div>
    <div id="result"></div>

    <div id="medAlert" class="alert red hidden">üö® Medico da informare üö®</div>

    <div class="row">
      <button class="btn2" onclick="go('s4')">‚¨Ö Indietro</button>
      <button class="btn" onclick="goHome()">Fine</button>
    </div>
  </div>
</main>
</section>

</div>

<script>
const STATE = { nurse:"", pid:"", accesso:"" };

function enterApp(){
  document.getElementById("splash").style.display="none";
  document.getElementById("app").classList.remove("hidden");
}

function startWizard(){
  document.getElementById("home").classList.add("hidden");
  go('s1');
}

function go(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function goHome(){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById("home").classList.remove("hidden");
}

function next1(){
  const v = (nurse.value||"").trim();
  if(!v){ alert("Inserisci la firma infermiere."); return; }
  STATE.nurse = v;
  go('s2');
}
function next2(){
  const v = (pid.value||"").trim();
  if(!v){ alert("Inserisci l'ID paziente."); return; }
  STATE.pid = v;
  go('s3');
}
function next3(){
  const v = accesso.value;
  if(!v){ alert("Seleziona il tipo di accesso."); return; }
  STATE.accesso = v;
  setupFlows();
  go('s4');
}

/* --- setup cascata differente --- */
function hideAllSteps(){
  // AV
  ["av2","av3","av4","av5"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  av_puntura.value=""; av_thrill.value=""; av_bruit.value=""; av_qb.value=""; av_allarmi.value="";
  progAV.textContent="Progress: 0/5";

  // CVC
  ["cvc2","cvc3","cvc4","cvc5"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  cvc_lumi.value=""; cvc_inversione.value=""; cvc_qb.value=""; cvc_allarmi.value=""; cvc_exit.value=""; cvc_febbre.value="";
  progCVC.textContent="Progress: 0/5";
}

function setupFlows(){
  hideAllSteps();
  flowAV.classList.add("hidden");
  flowCVC.classList.add("hidden");

  if(STATE.accesso==="CVC"){
    flowCVC.classList.remove("hidden");
  } else {
    flowAV.classList.remove("hidden");
  }
}

/* --- cascata AV --- */
function countAV(){
  let c=0;
  if(av_puntura.value) c++;
  if(av_thrill.value) c++;
  if(av_bruit.value) c++;
  if(av_qb.value) c++;
  if(av_allarmi.value) c++;
  return c;
}
av_puntura.addEventListener("change", ()=>{
  if(!av_puntura.value) return;
  av2.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/5`;
});
av_thrill.addEventListener("change", ()=>{
  if(!av_thrill.value) return;
  av3.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/5`;
});
av_bruit.addEventListener("change", ()=>{
  if(!av_bruit.value) return;
  av4.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/5`;
});
av_qb.addEventListener("change", ()=>{
  if(!av_qb.value) return;
  av5.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/5`;
});
av_allarmi.addEventListener("change", ()=> progAV.textContent = `Progress: ${countAV()}/5`);

/* --- cascata CVC --- */
function countCVC(){
  let c=0;
  if(cvc_lumi.value) c++;
  if(cvc_inversione.value) c++;
  if(cvc_qb.value) c++;
  if(cvc_allarmi.value) c++;
  if(cvc_exit.value && cvc_febbre.value) c++;
  return c;
}
cvc_lumi.addEventListener("change", ()=>{
  if(!cvc_lumi.value) return;
  cvc2.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
});
cvc_inversione.addEventListener("change", ()=>{
  if(!cvc_inversione.value) return;
  cvc3.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
});
cvc_qb.addEventListener("change", ()=>{
  if(!cvc_qb.value) return;
  cvc4.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
});
cvc_allarmi.addEventListener("change", ()=>{
  if(!cvc_allarmi.value) return;
  cvc5.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
});
cvc_exit.addEventListener("change", ()=> progCVC.textContent = `Progress: ${countCVC()}/5`);
cvc_febbre.addEventListener("change", ()=> progCVC.textContent = `Progress: ${countCVC()}/5`);

/* --- grading differenziato --- */
function calc(){
  medAlert.classList.add("hidden");

  if(STATE.accesso==="CVC"){
    if(!cvc_lumi.value || !cvc_inversione.value || !cvc_qb.value || !cvc_allarmi.value || !cvc_exit.value || !cvc_febbre.value){
      alert("Completa tutti i campi CVC."); return;
    }

    let g=0;

    // Critico
    if(cvc_lumi.value==="due") g=3;

    // Disfunzione probabile
    if(g<3){
      if(cvc_qb.value==="basso") g=Math.max(g,2);
      if(cvc_inversione.value==="si") g=Math.max(g,2);
      if(cvc_allarmi.value==="si") g=Math.max(g,2);
      if(cvc_exit.value==="essudato" || cvc_febbre.value==="si") g=Math.max(g,2);
    }

    // Warning
    if(g<2){
      if(cvc_lumi.value==="uno") g=Math.max(g,1);
      if(cvc_qb.value==="moderato") g=Math.max(g,1);
      if(cvc_exit.value==="rosso") g=Math.max(g,1);
    }

    renderResult(g);
    return;
  }

  // FAV/AVG
  if(!av_puntura.value || !av_thrill.value || !av_bruit.value || !av_qb.value || !av_allarmi.value){
    alert("Completa tutti i campi FAV/AVG."); return;
  }

  let g=0;

  // Critico
  if(av_puntura.value==="Impossibile" || av_thrill.value==="Assente") g=3;

  // Disfunzione probabile
  if(g<3){
    if(av_bruit.value==="Alto-pitch") g=Math.max(g,2);
    if(av_qb.value==="basso") g=Math.max(g,2);
    if(av_allarmi.value==="entrambi") g=Math.max(g,2);
  }

  // Warning
  if(g<2){
    if(av_puntura.value==="Difficile") g=Math.max(g,1);
    if(av_thrill.value==="Ridotto") g=Math.max(g,1);
    if(av_qb.value==="moderato") g=Math.max(g,1);
    if(av_allarmi.value==="arteriosi" || av_allarmi.value==="venosi") g=Math.max(g,1);
  }

  renderResult(g);
}

function renderResult(g){
  let cls = "g"+g;
  let txt = [
    "G0 ‚Äì Routine: proseguire sorveglianza.",
    "G1 ‚Äì Warning: ricontrollo ravvicinato.",
    "G2 ‚Äì Disfunzione probabile: valutazione medica/eco.",
    "G3 ‚Äì Critico: gestione urgente oggi."
  ][g];

  result.innerHTML = `
    <div class="stepSub" style="margin-bottom:10px">
      Infermiere: <b>${escapeHtml(STATE.nurse)}</b> ¬∑ Paziente: <b>${escapeHtml(STATE.pid)}</b> ¬∑ Accesso: <b>${STATE.accesso}</b>
    </div>
    <span class="badge ${cls}">${txt}</span>
  `;

  if(g>=2) medAlert.classList.remove("hidden");
  go('s5');
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
</script>

</body>
</html>
