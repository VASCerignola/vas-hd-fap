<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VAS-HD (FAP)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c86a9a">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
:root{
  --bg:#120b10; --card:#1b0f17; --line:#6b2b4a;
  --txt:#f2e9ee; --mut:#d6b3c4; --accent:#c86a9a;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui;background:var(--bg);color:var(--txt)}
.hidden{display:none}

/* ===== BACKGROUND STEP ===== */
.step-bg{
  position:relative;
  min-height:100vh;
  background-size:cover;
  background-position:center;
  background-color:#120b10;
}
.step-bg::before{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(18,11,16,0.75);
}
.step-bg > *{position:relative;z-index:1}

.bg-nurse{background-image:url('bg-nurse.jpg')}
.bg-patient{background-image:url('bg-patient.jpg')}
.bg-access{background-image:url('bg-access.jpg')}
.bg-checklist{background-image:url('bg-checklist.jpg')}
.bg-result{background-image:url('bg-result.jpg')}

/* ===== SPLASH ===== */
#splash{
  position:fixed;inset:0;background:#120b10;
  display:flex;align-items:center;justify-content:center;z-index:9999
}
#splash img{max-width:100%;max-height:100%;object-fit:contain}

/* ===== UI ===== */
header{padding:14px;border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
small{color:var(--mut)}
main{padding:14px;max-width:920px;margin:auto}

.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:rgba(27,15,23,.95);
  margin-bottom:14px;
}

label{font-size:12px;color:var(--mut);display:block;margin:14px 0 6px}
input,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#0f0a0d;
  color:var(--txt)
}
.row{display:flex;gap:10px;margin-top:14px}
.btn, .btn2{
  width:100%;
  padding:14px;
  border-radius:14px;
  font-weight:900;
}
.btn{border:0;background:var(--accent);color:white}
.btn2{border:1px solid var(--line);background:transparent;color:var(--txt)}
.btn:disabled{opacity:.45}

.stepTitle{font-weight:900;font-size:16px}
.stepSub{color:var(--mut);margin-top:4px}
.progress{margin-top:10px;color:var(--mut);font-weight:800}

.badge{display:inline-block;padding:10px 14px;border-radius:999px;font-weight:900;color:white}
.g0{background:#3b7d5b}.g1{background:#b58b2a}.g2{background:#c46a2d}.g3{background:#b11226}

.alert{margin-top:12px;padding:12px;border-radius:12px;font-weight:900}
.alert.red{background:#b11226}

hr{border:0;border-top:1px solid var(--line);margin:14px 0}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--mut);font-weight:800}
.box{
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  margin-top:12px;
  background:rgba(15,10,13,.45);
}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash" onclick="enterApp()">
  <img src="splash.png" alt="VAS-HD">
</div>

<div id="app" class="hidden">

<header>
  <h1>VAS-HD (FAP)</h1>
  <small>ü©∏ Sorveglianza accessi vascolari ‚Äì wizard a cascata</small>
</header>

<!-- HOME -->
<main id="home">
  <div class="card">
    <div class="stepTitle">üìã Avvio</div>
    <div class="stepSub">Infermiere ‚Üí Paziente ‚Üí Accesso ‚Üí Checklist ‚Üí Grading.</div>
    <div class="kpi">
      <span class="pill">FAV/AVG: clinico + funzionale</span>
      <span class="pill">CVC: funzionale + exit-site</span>
    </div>
  </div>
  <button class="btn" onclick="startWizard()">‚ûï NUOVA SEDUTA</button>
</main>

<!-- STEP 1 -->
<section id="s1" class="hidden step-bg bg-nurse">
<main>
  <div class="card">
    <div class="stepTitle">üßë‚Äç‚öïÔ∏è Identificazione infermiere</div>
    <div class="stepSub">Firma o sigla per tracciabilit√†.</div>
    <label>Firma</label>
    <input id="nurse" placeholder="Es. M.R. / Maria Rossi">
    <div class="row">
      <button class="btn2" onclick="goHome()">‚Ü© Esci</button>
      <button class="btn" onclick="next1()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 2 -->
<section id="s2" class="hidden step-bg bg-patient">
<main>
  <div class="card">
    <div class="stepTitle">üßæ Identificazione paziente</div>
    <div class="stepSub">ID breve (es. GR72).</div>
    <label>ID paziente</label>
    <input id="pid" placeholder="Es. GR72">
    <div class="row">
      <button class="btn2" onclick="go('s1')">‚¨Ö Indietro</button>
      <button class="btn" onclick="next2()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 3 -->
<section id="s3" class="hidden step-bg bg-access">
<main>
  <div class="card">
    <div class="stepTitle">ü©∏ Tipo di accesso</div>
    <div class="stepSub">La cascata cambia in base all‚Äôaccesso selezionato.</div>
    <label>Accesso</label>
    <select id="accesso">
      <option value="">‚Äî seleziona ‚Äî</option>
      <option value="FAV">FAV</option>
      <option value="AVG">AVG (graft)</option>
      <option value="CVC">CVC</option>
    </select>
    <div class="row">
      <button class="btn2" onclick="go('s2')">‚¨Ö Indietro</button>
      <button class="btn" onclick="next3()">Avanti ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 4 -->
<section id="s4" class="hidden step-bg bg-checklist">
<main>
  <div class="card">
    <div class="stepTitle">üîç Sorveglianza dell‚Äôaccesso vascolare</div>
    <div class="stepSub">Una domanda sblocca la successiva. ‚ÄúCalcola‚Äù si attiva solo a cascata completa.</div>

    <!-- FLOW FAV/AVG -->
    <div id="flowAV" class="hidden">
      <div class="progress" id="progAV">Progress: 0/5</div>

      <div id="av1">
        <label>1) Puntura</label>
        <select id="av_puntura">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="facile">Facile</option>
          <option value="difficile">Difficile</option>
          <option value="impossibile">Impossibile</option>
        </select>
      </div>

      <div id="av2" class="hidden">
        <label>2) Thrill</label>
        <select id="av_thrill">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="normale">Normale</option>
          <option value="ridotto">Ridotto</option>
          <option value="assente">Assente</option>
        </select>
      </div>

      <div id="av3" class="hidden">
        <label>3) Bruit</label>
        <select id="av_bruit">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="normale">Normale</option>
          <option value="alto">Alto-pitch</option>
          <option value="assente">Assente</option>
        </select>
      </div>

      <div id="av4" class="hidden">
        <label>4) Qb ottenuto (rispetto al prescritto)</label>
        <select id="av_qb">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">‚â• 95%</option>
          <option value="moderato">85‚Äì94%</option>
          <option value="basso">&lt; 85%</option>
        </select>
      </div>

      <div id="av5" class="hidden">
        <label>5) Allarmi ripetuti</label>
        <select id="av_allarmi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="arteriosi">Arteriosi</option>
          <option value="venosi">Venosi</option>
          <option value="entrambi">Entrambi</option>
        </select>
      </div>

      <!-- SOLO AVG -->
      <div id="av6" class="hidden">
        <hr>
        <div class="stepTitle">üß© Modulo specifico AVG (graft)</div>
        <div class="stepSub">Valuta cute e graft: segni di infezione/pseudoaneurisma/ulcerazioni.</div>

        <label>6) Cute/graft</label>
        <select id="avg_graft">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">Regolare</option>
          <option value="sospetto">Sospetto (arrossamento/dolore/calore/ulcerazione/pseudoaneurisma)</option>
        </select>
      </div>
    </div>

    <!-- FLOW CVC -->
    <div id="flowCVC" class="hidden">
      <div class="progress" id="progCVC">Progress: 0/5</div>

      <div id="cvc1">
        <label>1) Funzionalit√† lumi</label>
        <select id="cvc_lumi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">OK entrambi</option>
          <option value="uno">Problema 1 lume</option>
          <option value="due">Problema entrambi</option>
        </select>
      </div>

      <div id="cvc2" class="hidden">
        <label>2) Qb ottenuto (rispetto al prescritto)</label>
        <select id="cvc_qb">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">‚â• 95%</option>
          <option value="moderato">85‚Äì94%</option>
          <option value="basso">&lt; 85%</option>
        </select>
      </div>

      <div id="cvc3" class="hidden">
        <label>3) Allarmi ripetuti</label>
        <select id="cvc_allarmi">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>

      <div id="cvc4" class="hidden">
        <label>4) Inversione linee necessaria</label>
        <select id="cvc_inversione">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>

      <div id="cvc5" class="hidden">
        <label>5) Exit-site / infezione</label>
        <select id="cvc_exit">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="ok">OK</option>
          <option value="rosso">Arrossato</option>
          <option value="essudato">Essudato</option>
        </select>

        <label style="margin-top:12px">Febbre</label>
        <select id="cvc_febbre">
          <option value="">‚Äî seleziona ‚Äî</option>
          <option value="no">No</option>
          <option value="si">S√¨</option>
        </select>
      </div>
    </div>

    <div class="row">
      <button class="btn2" onclick="go('s3')">‚¨Ö Indietro</button>
      <button id="btnCalc" class="btn" onclick="calc()" disabled>Calcola ‚ûú</button>
    </div>
  </div>
</main>
</section>

<!-- STEP 5 -->
<section id="s5" class="hidden step-bg bg-result">
<main>
  <div class="card">
    <div class="stepTitle">üìä Grading + Azione</div>

    <div id="result"></div>

    <div class="box" id="actionBox" class="hidden"></div>

    <div class="box">
      <div class="stepTitle">üì£ Da comunicare (pronto)</div>
      <div id="handoff" class="mono" style="margin-top:10px;white-space:pre-wrap"></div>
    </div>

    <div id="medBlock" class="box hidden">
      <div class="alert red">üö® G2‚ÄìG3: obbligatorio informare il medico</div>
      <label>Medico informato</label>
      <select id="medicoInf">
        <option value="">‚Äî seleziona ‚Äî</option>
        <option value="si">S√¨</option>
        <option value="no">No</option>
      </select>
      <div class="stepSub" style="margin-top:8px">
        Per chiudere la seduta con G2‚ÄìG3 devi selezionare <b>S√¨</b>.
      </div>
    </div>

    <div class="row">
      <button class="btn2" onclick="go('s4')">‚¨Ö Indietro</button>
      <button id="btnFinish" class="btn" onclick="finish()">Fine</button>
    </div>
  </div>
</main>
</section>

</div>

<script>
const STATE = { nurse:"", pid:"", accesso:"" };
let LAST = { grade:0, summary:"", details:"" };

function enterApp(){
  document.getElementById("splash").style.display="none";
  document.getElementById("app").classList.remove("hidden");
}
function startWizard(){
  document.getElementById("home").classList.add("hidden");
  go('s1');
}
function go(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function goHome(){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById("home").classList.remove("hidden");
}

/* ===== NAV ===== */
function next1(){
  const v = (nurse.value||"").trim();
  if(!v){ alert("Inserisci la firma infermiere."); return; }
  STATE.nurse = v;
  go('s2');
}
function next2(){
  const v = (pid.value||"").trim();
  if(!v){ alert("Inserisci l'ID paziente."); return; }
  STATE.pid = v;
  go('s3');
}
function next3(){
  const v = accesso.value;
  if(!v){ alert("Seleziona il tipo di accesso."); return; }
  STATE.accesso = v;
  setupFlows();
  go('s4');
}

/* ===== RESET / FLOW ===== */
function resetAV(){
  av_puntura.value=""; av_thrill.value=""; av_bruit.value=""; av_qb.value=""; av_allarmi.value="";
  avg_graft.value="";
  av2.classList.add("hidden"); av3.classList.add("hidden"); av4.classList.add("hidden"); av5.classList.add("hidden"); av6.classList.add("hidden");
  progAV.textContent = `Progress: 0/${totalAV()}`;
}
function resetCVC(){
  cvc_lumi.value=""; cvc_qb.value=""; cvc_allarmi.value=""; cvc_inversione.value=""; cvc_exit.value=""; cvc_febbre.value="";
  cvc2.classList.add("hidden"); cvc3.classList.add("hidden"); cvc4.classList.add("hidden"); cvc5.classList.add("hidden");
  progCVC.textContent="Progress: 0/5";
}
function setupFlows(){
  btnCalc.disabled = true;
  flowAV.classList.add("hidden");
  flowCVC.classList.add("hidden");
  resetAV(); resetCVC();

  if(STATE.accesso==="CVC"){
    flowCVC.classList.remove("hidden");
  }else{
    flowAV.classList.remove("hidden");
  }
}
function totalAV(){
  return (STATE.accesso==="AVG") ? 6 : 5;
}

/* ===== COUNT ===== */
function countAV(){
  let c=0;
  if(av_puntura.value) c++;
  if(av_thrill.value) c++;
  if(av_bruit.value) c++;
  if(av_qb.value) c++;
  if(av_allarmi.value) c++;
  if(STATE.accesso==="AVG" && avg_graft.value) c++;
  return c;
}
function countCVC(){
  let c=0;
  if(cvc_lumi.value) c++;
  if(cvc_qb.value) c++;
  if(cvc_allarmi.value) c++;
  if(cvc_inversione.value) c++;
  if(cvc_exit.value && cvc_febbre.value) c++;
  return c;
}
function updateCalcEnabled(){
  if(STATE.accesso==="CVC"){
    btnCalc.disabled = !(countCVC()===5);
  }else{
    btnCalc.disabled = !(countAV()===totalAV());
  }
}

/* ===== CASCATA AV: reset a valle + sblocco sequenziale ===== */
av_puntura.addEventListener("change", ()=>{
  // reset a valle
  av_thrill.value=""; av_bruit.value=""; av_qb.value=""; av_allarmi.value=""; avg_graft.value="";
  av2.classList.add("hidden"); av3.classList.add("hidden"); av4.classList.add("hidden"); av5.classList.add("hidden"); av6.classList.add("hidden");

  if(!av_puntura.value){
    progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
    updateCalcEnabled(); return;
  }
  av2.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

av_thrill.addEventListener("change", ()=>{
  av_bruit.value=""; av_qb.value=""; av_allarmi.value=""; avg_graft.value="";
  av3.classList.add("hidden"); av4.classList.add("hidden"); av5.classList.add("hidden"); av6.classList.add("hidden");

  if(!av_thrill.value){
    progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
    updateCalcEnabled(); return;
  }
  av3.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

av_bruit.addEventListener("change", ()=>{
  av_qb.value=""; av_allarmi.value=""; avg_graft.value="";
  av4.classList.add("hidden"); av5.classList.add("hidden"); av6.classList.add("hidden");

  if(!av_bruit.value){
    progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
    updateCalcEnabled(); return;
  }
  av4.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

av_qb.addEventListener("change", ()=>{
  av_allarmi.value=""; avg_graft.value="";
  av5.classList.add("hidden"); av6.classList.add("hidden");

  if(!av_qb.value){
    progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
    updateCalcEnabled(); return;
  }
  av5.classList.remove("hidden");
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

av_allarmi.addEventListener("change", ()=>{
  avg_graft.value="";
  av6.classList.add("hidden");

  if(!av_allarmi.value){
    progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
    updateCalcEnabled(); return;
  }

  // se AVG, sblocca modulo graft; se FAV chiude qui
  if(STATE.accesso==="AVG"){
    av6.classList.remove("hidden");
  }
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

avg_graft.addEventListener("change", ()=>{
  progAV.textContent = `Progress: ${countAV()}/${totalAV()}`;
  updateCalcEnabled();
});

/* ===== CASCATA CVC ===== */
cvc_lumi.addEventListener("change", ()=>{
  cvc_qb.value=""; cvc_allarmi.value=""; cvc_inversione.value=""; cvc_exit.value=""; cvc_febbre.value="";
  cvc2.classList.add("hidden"); cvc3.classList.add("hidden"); cvc4.classList.add("hidden"); cvc5.classList.add("hidden");

  if(!cvc_lumi.value){
    progCVC.textContent = `Progress: ${countCVC()}/5`;
    updateCalcEnabled(); return;
  }
  cvc2.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});

cvc_qb.addEventListener("change", ()=>{
  cvc_allarmi.value=""; cvc_inversione.value=""; cvc_exit.value=""; cvc_febbre.value="";
  cvc3.classList.add("hidden"); cvc4.classList.add("hidden"); cvc5.classList.add("hidden");

  if(!cvc_qb.value){
    progCVC.textContent = `Progress: ${countCVC()}/5`;
    updateCalcEnabled(); return;
  }
  cvc3.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});

cvc_allarmi.addEventListener("change", ()=>{
  cvc_inversione.value=""; cvc_exit.value=""; cvc_febbre.value="";
  cvc4.classList.add("hidden"); cvc5.classList.add("hidden");

  if(!cvc_allarmi.value){
    progCVC.textContent = `Progress: ${countCVC()}/5`;
    updateCalcEnabled(); return;
  }
  cvc4.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});

cvc_inversione.addEventListener("change", ()=>{
  cvc_exit.value=""; cvc_febbre.value="";
  cvc5.classList.add("hidden");

  if(!cvc_inversione.value){
    progCVC.textContent = `Progress: ${countCVC()}/5`;
    updateCalcEnabled(); return;
  }
  cvc5.classList.remove("hidden");
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});

cvc_exit.addEventListener("change", ()=>{
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});
cvc_febbre.addEventListener("change", ()=>{
  progCVC.textContent = `Progress: ${countCVC()}/5`;
  updateCalcEnabled();
});

/* ===== GRADING + AZIONE + HANDOFF ===== */
function calc(){
  let g=0;
  let flags = [];

  if(STATE.accesso==="CVC"){
    if(countCVC()!==5){ alert("Completa la cascata CVC."); return; }

    if(cvc_lumi.value==="due"){ g=3; flags.push("problema entrambi i lumi"); }
    if(cvc_lumi.value==="uno"){ flags.push("problema 1 lume"); }

    if(cvc_qb.value==="basso"){ g=Math.max(g,2); flags.push("Qb <85%"); }
    if(cvc_qb.value==="moderato"){ g=Math.max(g,1); flags.push("Qb 85‚Äì94%"); }

    if(cvc_allarmi.value==="si"){ g=Math.max(g,2); flags.push("allarmi ripetuti"); }
    if(cvc_inversione.value==="si"){ g=Math.max(g,2); flags.push("inversione linee"); }

    if(cvc_exit.value==="essudato"){ g=Math.max(g,2); flags.push("exit-site essudato"); }
    if(cvc_exit.value==="rosso"){ g=Math.max(g,1); flags.push("exit-site arrossato"); }
    if(cvc_febbre.value==="si"){ g=Math.max(g,2); flags.push("febbre"); }
  } else {
    const tot = totalAV();
    if(countAV()!==tot){ alert("Completa la cascata FAV/AVG."); return; }

    if(av_puntura.value==="impossibile"){ g=3; flags.push("puntura impossibile"); }
    if(av_puntura.value==="difficile"){ g=Math.max(g,1); flags.push("puntura difficile"); }

    if(av_thrill.value==="assente"){ g=3; flags.push("thrill assente"); }
    if(av_thrill.value==="ridotto"){ g=Math.max(g,1); flags.push("thrill ridotto"); }

    if(av_bruit.value==="alto"){ g=Math.max(g,2); flags.push("bruit alto-pitch"); }
    if(av_bruit.value==="assente"){ g=Math.max(g,2); flags.push("bruit assente"); }

    if(av_qb.value==="basso"){ g=Math.max(g,2); flags.push("Qb <85%"); }
    if(av_qb.value==="moderato"){ g=Math.max(g,1); flags.push("Qb 85‚Äì94%"); }

    if(av_allarmi.value==="entrambi"){ g=Math.max(g,2); flags.push("allarmi entrambi"); }
    if(av_allarmi.value==="arteriosi"){ g=Math.max(g,1); flags.push("allarmi arteriosi"); }
    if(av_allarmi.value==="venosi"){ g=Math.max(g,1); flags.push("allarmi venosi"); }

    if(STATE.accesso==="AVG"){
      if(avg_graft.value==="sospetto"){ g=Math.max(g,2); flags.push("cute/graft sospetto"); }
      if(avg_graft.value==="ok"){ flags.push("cute/graft regolare"); }
    }
  }

  LAST.grade = g;
  LAST.summary = flags.join(", ");

  renderResult(g, LAST.summary);
  go('s5');
}

function renderResult(g, flags){
  const cls = "g"+g;
  const txt = [
    "G0 ‚Äì Routine: proseguire sorveglianza.",
    "G1 ‚Äì Warning: ricontrollo ravvicinato.",
    "G2 ‚Äì Disfunzione probabile: valutazione medica/eco.",
    "G3 ‚Äì Critico: gestione urgente oggi."
  ][g];

  const action = actionPlan(g, STATE.accesso);
  const handoffText = buildHandoff(g, STATE.accesso, flags);

  result.innerHTML = `
    <div class="stepSub" style="margin-bottom:10px">
      Infermiere: <b>${escapeHtml(STATE.nurse)}</b> ¬∑ Paziente: <b>${escapeHtml(STATE.pid)}</b> ¬∑ Accesso: <b>${STATE.accesso}</b>
    </div>
    <span class="badge ${cls}">${txt}</span>
    <div class="stepSub" style="margin-top:10px">
      Rilievi: <b>${escapeHtml(flags || "‚Äî")}</b>
    </div>
  `;

  actionBox.innerHTML = `
    <div class="stepTitle">üß≠ Azione consigliata</div>
    <div style="margin-top:10px;white-space:pre-wrap">${escapeHtml(action)}</div>
  `;

  handoff.textContent = handoffText;

  // medico informato: obbligo per G2‚ÄìG3
  medicoInf.value = "";
  medBlock.classList.toggle("hidden", !(g>=2));
  btnFinish.disabled = false;
  if(g>=2){
    btnFinish.disabled = true;
  }
}

function actionPlan(g, accesso){
  if(g===0){
    return "‚Ä¢ Proseguire trattamento.\n‚Ä¢ Sorveglianza routinaria alla prossima seduta.";
  }
  if(g===1){
    return "‚Ä¢ Ricontrollo ravvicinato (prossima seduta o entro 1 settimana).\n‚Ä¢ Se peggiora o persiste ‚Üí informare il medico.";
  }
  if(g===2){
    if(accesso==="CVC"){
      return "‚Ä¢ Informare il medico oggi.\n‚Ä¢ Considerare valutazione funzionale CVC (posizione, lock, troubleshooting) ed eventuale ecografia/valutazione clinica.\n‚Ä¢ Attenzione a segni di infezione: exit-site/febbre.";
    }
    return "‚Ä¢ Informare il medico oggi.\n‚Ä¢ Considerare eco accesso/valutazione per stenosi o disfunzione.\n‚Ä¢ Se necessario pianificare percorso diagnostico-interventistico.";
  }
  // g===3
  if(accesso==="CVC"){
    return "‚Ä¢ Informare il medico immediatamente.\n‚Ä¢ Valutare urgenza: impossibilit√† di dialisi efficace / problemi su entrambi i lumi.\n‚Ä¢ Considerare sostituzione/gestione urgente secondo protocollo di reparto.";
  }
  return "‚Ä¢ Informare il medico immediatamente.\n‚Ä¢ Valutare urgenza: accesso critico (thrill assente/puntura impossibile).\n‚Ä¢ Considerare gestione urgente secondo protocollo (eco/angiografia/decisione clinica).";
}

function buildHandoff(g, accesso, flags){
  const gtxt = `G${g}`;
  const base = `${gtxt} ‚Äì ${accesso} ‚Äì ${STATE.pid} ‚Äì Infermiere ${STATE.nurse}`;
  const det = flags ? `Rilievi: ${flags}.` : "Rilievi: ‚Äî.";
  const req = (g>=2) ? "Azione: medico informato oggi." : "Azione: sorveglianza.";
  return `${base}\n${det}\n${req}`;
}

medicoInf.addEventListener("change", ()=>{
  if(LAST.grade>=2){
    btnFinish.disabled = (medicoInf.value!=="si");
  }
});

function finish(){
  if(LAST.grade>=2 && medicoInf.value!=="si"){
    alert("Per G2‚ÄìG3 devi selezionare: Medico informato = S√¨.");
    return;
  }
  goHome();
}

/* ===== UTILS ===== */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
  /* =========================
   SALVATAGGIO LOCALE + CSV
   ========================= */

function saveSession(){
  const record = {
    date: new Date().toISOString(),
    infermiere: STATE.nurse,
    paziente: STATE.pid,
    accesso: STATE.accesso,
    grading: LAST.grade,
    rilievi: LAST.summary
  };

  const key = "VAS_HD_FAP_SESSIONS";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  arr.unshift(record);
  localStorage.setItem(key, JSON.stringify(arr));
}

function loadSessions(){
  return JSON.parse(localStorage.getItem("VAS_HD_FAP_SESSIONS") || "[]");
}

function exportCSV(){
  const rows = loadSessions();
  if(rows.length===0){
    alert("Nessuna seduta salvata.");
    return;
  }

  const header = ["Data","Infermiere","Paziente","Accesso","Grading","Rilievi"];
  const csv = [
    header.join(";"),
    ...rows.map(r=>[
      r.date,
      r.infermiere,
      r.paziente,
      r.accesso,
      "G"+r.grading,
      r.rilievi
    ].join(";"))
  ].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "VAS-HD_FAP_sedute.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* intercetta chiusura corretta */
const _finish = finish;
finish = function(){
  if(LAST.grade>=2 && medicoInf.value!=="si"){
    alert("Per G2‚ÄìG3 devi selezionare: Medico informato = S√¨.");
    return;
  }
  saveSession();
  goHome();
};

</script>

</body>
</html>

