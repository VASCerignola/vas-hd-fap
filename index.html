/* =========================
   STORICO VISIVO
   ========================= */

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("it-IT", {year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }catch(e){ return iso; }
}

function renderHistory(){
  const el = document.getElementById("history");
  if(!el) return;

  const rows = loadSessions();
  if(rows.length===0){
    el.innerHTML = `<div class="hitem"><div class="hmeta">Nessuna seduta salvata.</div></div>`;
    return;
  }

  el.innerHTML = rows.slice(0,30).map((r, idx)=>`
    <div class="hitem">
      <div class="hrow">
        <div>
          <div class="hmain">${escapeHtml(r.paziente)} ¬∑ ${escapeHtml(r.accesso)} ¬∑ <span class="badge g${r.grading}">G${r.grading}</span></div>
          <div class="hmeta">${fmtDate(r.date)} ¬∑ Inf: ${escapeHtml(r.infermiere)}</div>
        </div>
        <button class="hbtn" onclick="deleteSession(${idx})">üóëÔ∏è</button>
      </div>
      <div class="hmeta" style="margin-top:8px">Rilievi: ${escapeHtml(r.rilievi || "‚Äî")}</div>
    </div>
  `).join("");
}

function deleteSession(index){
  const key = "VAS_HD_FAP_SESSIONS";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  if(index<0 || index>=arr.length) return;
  arr.splice(index,1);
  localStorage.setItem(key, JSON.stringify(arr));
  renderHistory();
}

function clearAll(){
  if(!confirm("Vuoi cancellare TUTTO lo storico sul dispositivo?")) return;
  localStorage.removeItem("VAS_HD_FAP_SESSIONS");
  renderHistory();
}

/* aggiorna lo storico quando torni a Home */
const _goHome = goHome;
goHome = function(){
  _goHome();
  renderHistory();
};

/* aggiorna lo storico all‚Äôavvio app */
const _enterApp = enterApp;
enterApp = function(){
  _enterApp();
  renderHistory();
};
