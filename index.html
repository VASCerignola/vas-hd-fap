<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VAS-HD (FAP)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c86a9a">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
:root{
 --bg:#120b10;--card:#1b0f17;--line:#6b2b4a;
 --txt:#f2e9ee;--mut:#d6b3c4;--accent:#c86a9a
}
body{margin:0;font-family:-apple-system,system-ui;background:var(--bg);color:var(--txt)}
header{padding:14px;border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
small{color:var(--mut)}
main{padding:14px;max-width:980px;margin:0 auto}
.card{border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px;background:var(--card)}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:780px){.grid{grid-template-columns:1fr 1fr}}
label{font-size:12px;color:var(--mut)}
select,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f0a0d;color:var(--txt)}
.row{display:flex;gap:10px}
.btn{width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;background:var(--accent);color:white}
.btn2{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);font-weight:900;background:transparent;color:var(--txt)}
.badge{padding:6px 12px;border-radius:999px;font-weight:900;color:white}
.g0{background:#3b7d5b}.g1{background:#b58b2a}.g2{background:#c46a2d}.g3{background:#b11226}
.alert{padding:12px;border-radius:12px;margin-top:10px;font-weight:900}
.alert.red{background:#b11226}
.hidden{display:none}

/* Sirena lampeggiante */
@keyframes blink { 0%{opacity:1} 50%{opacity:.2} 100%{opacity:1} }
.siren{animation:blink 1s infinite;text-align:center}

/* Fallback iPhone: flash schermo */
.flash{animation:blink .25s 3}
</style>
</head>

<body>
<header>
 <h1>VAS-HD (FAP)</h1>
 <small>ğŸ©¸ Sorveglianza accessi vascolari</small>
</header>

<main>

<section id="home">
 <div class="card">
  <b>ğŸ“‹ Ultime sedute</b>
  <div id="history" style="margin-top:10px;color:var(--mut)">Nessuna seduta.</div>
  <div class="row" style="margin-top:10px">
   <button class="btn2" onclick="exportCSV()">ğŸ“¤ ESPORTA EXCEL</button>
   <button class="btn2" onclick="clearAll()">ğŸ—‘ï¸ SVUOTA</button>
  </div>
 </div>
 <button class="btn" onclick="go('form')">â• NUOVA SEDUTA</button>
</section>

<section id="form" class="hidden">
 <div class="card">
  <b>ğŸ§‘â€âš•ï¸ Dati seduta</b>
  <div class="grid" style="margin-top:10px">
   <div><label>ID paziente</label><input id="pid" placeholder="GR72"></div>
   <div><label>ğŸ§‘â€âš•ï¸ Firma infermiere</label><input id="firma" placeholder="Sigla / Nome"></div>

   <div><label>Accesso</label><select id="accesso"><option>FAV</option><option>AVG</option><option>CVC</option></select></div>
   <div><label>Puntura</label><select id="puntura"><option>Facile</option><option>Difficile</option><option>Impossibile</option></select></div>
   <div><label>Thrill</label><select id="thrill"><option>Normale</option><option>Ridotto</option><option>Assente</option></select></div>
  </div>

  <div class="row" style="margin-top:12px">
   <button class="btn2" onclick="go('home')">â†©ï¸ ANNULLA</button>
   <button class="btn" onclick="calcola()">âš™ï¸ CALCOLA</button>
  </div>
 </div>
</section>

<section id="result" class="hidden">
 <div class="card">
  <b>ğŸ“Š Esito</b>
  <div style="margin-top:10px">
   <span id="badge" class="badge g0">G0</span>

   <div id="alertMedico" class="alert red siren hidden">
    ğŸš¨ COMUNICARE IMMEDIATAMENTE AL MEDICO ğŸš¨
   </div>

   <div id="medicoBox" class="hidden" style="margin-top:10px">
     <label>ğŸ‘¨â€âš•ï¸ Medico informato</label>
     <select id="medicoInf">
       <option value="">â€” seleziona â€”</option>
       <option>SÃ¬</option>
       <option>No</option>
     </select>
   </div>
  </div>
 </div>

 <div class="row">
  <button class="btn2" onclick="go('form')">âœï¸ MODIFICA</button>
  <button class="btn" onclick="salva()">ğŸ’¾ SALVA</button>
 </div>
</section>

<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }

const KEY="vashd_fap_sessions_v4";

function go(id){
  ['home','form','result'].forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* Haptic / vibrazione: funziona su Android; su iPhone fallback flash (Safari/PWA non vibra) */
function alertHaptic(level){
  if (navigator.vibrate){
    if (level === 3) navigator.vibrate([200,80,200,80,400]);
    else navigator.vibrate([150,80,150]);
    return;
  }
  document.body.classList.add('flash');
  setTimeout(()=>document.body.classList.remove('flash'), 700);
}

function calcola(){
  let g=0;

  // v0 logica minima (puoi raffinarla quando vuoi)
  if (thrill.value==='Assente' || puntura.value==='Impossibile') g=3;

  badge.className='badge g'+g;
  badge.textContent='G'+g;

  const needMedico = g>=2;
  alertMedico.classList.toggle('hidden', !needMedico);
  medicoBox.classList.toggle('hidden', !needMedico);

  window.lastGrade=g;

  // vibrazione/flash se G2â€“G3 (in questa v0 solo G3 puÃ² uscire, ma Ã¨ giÃ  pronto)
  if (g >= 2) alertHaptic(g);

  go('result');
}

function salva(){
  if(!pid.value.trim()){
    alert('Inserisci ID paziente.');
    return;
  }
  if(!firma.value.trim()){
    alert('Inserisci firma infermiere.');
    return;
  }
  if(lastGrade>=2 && medicoInf.value!=='SÃ¬'){
    alert('Per G2â€“G3 devi informare il medico (seleziona SÃ¬).');
    return;
  }

  const sessions = JSON.parse(localStorage.getItem(KEY)||"[]");
  sessions.push({
    ts:Date.now(),
    id:pid.value.trim(),
    accesso:accesso.value,
    grade:lastGrade,
    firma:firma.value.trim(),
    medico:(lastGrade>=2 ? medicoInf.value : "")
  });
  localStorage.setItem(KEY, JSON.stringify(sessions));
  render();
  go('home');
}

function render(){
  const h=document.getElementById('history');
  const s=JSON.parse(localStorage.getItem(KEY)||"[]");
  h.innerHTML = s.length
    ? s.slice().reverse().slice(0,20).map(e=>{
        const dt=new Date(e.ts).toLocaleString('it-IT');
        const med = (e.grade>=2 ? ` â€¢ ğŸ‘¨â€âš•ï¸ ${e.medico||''}` : '');
        return `${dt} â€¢ ${e.id} â€¢ <b>G${e.grade}</b> â€¢ ğŸ§‘â€âš•ï¸ ${e.firma}${med}`;
      }).join('<br>')
    : "Nessuna seduta.";
}

function clearAll(){
  if(confirm('Svuotare tutte le sedute salvate su questo dispositivo?')){
    localStorage.removeItem(KEY);
    render();
  }
}

function exportCSV(){
  const s=JSON.parse(localStorage.getItem(KEY)||"[]");
  if(!s.length){ alert('Nessun dato da esportare.'); return; }

  const header = "Data;ID;Accesso;Grading;Infermiere;Medico informato\n";
  const rows = s.map(e=>{
    const dt=new Date(e.ts).toLocaleString('it-IT');
    return `${dt};${e.id};${e.accesso};G${e.grade};${e.firma};${e.medico||''}`;
  }).join("\n");

  const csv = header + rows;
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const today=new Date().toISOString().slice(0,10);
  a.download=`VAS-HD_sedute_${today}.csv`;
  a.click();
}

render();
</script>

</main>
</body>
</html>
