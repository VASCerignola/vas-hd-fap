<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VAS-HD (FAP)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c86a9a">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
:root{
 --bg:#120b10;--card:#1b0f17;--line:#6b2b4a;
 --txt:#f2e9ee;--mut:#d6b3c4;--accent:#c86a9a
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui;background:var(--bg);color:var(--txt)}

.hidden{display:none}

/* SPLASH */
#splash{
 position:fixed;
 inset:0;
 background:#120b10;
 display:flex;
 align-items:center;
 justify-content:center;
 z-index:9999;
}
#splash img{
 max-width:100%;
 max-height:100%;
 object-fit:contain;
}

/* APP */
header{padding:14px;border-bottom:1px solid var(--line)}
h1{margin:0;font-size:20px}
small{color:var(--mut)}
main{padding:14px;max-width:980px;margin:0 auto}
.card{border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px;background:var(--card)}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:780px){.grid{grid-template-columns:1fr 1fr}}
label{font-size:12px;color:var(--mut)}
select,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f0a0d;color:var(--txt)}
.row{display:flex;gap:10px}
.btn{width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;background:var(--accent);color:white}
.btn2{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);font-weight:900;background:transparent;color:var(--txt)}
.badge{padding:6px 12px;border-radius:999px;font-weight:900;color:white}
.g0{background:#3b7d5b}.g1{background:#b58b2a}.g2{background:#c46a2d}.g3{background:#b11226}
.alert{padding:12px;border-radius:12px;margin-top:10px;font-weight:900}
.alert.red{background:#b11226}

/* sirena */
@keyframes blink{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
.siren{animation:blink 1s infinite;text-align:center}
.flash{animation:blink .25s 3}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash" onclick="enterApp()">
  <img src="splash.png" alt="VAS-HD">
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
 <h1>VAS-HD (FAP)</h1>
 <small>ğŸ©¸ Sorveglianza accessi vascolari</small>
</header>

<main>

<section id="home">
 <div class="card">
  <b>ğŸ“‹ Ultime sedute</b>
  <div id="history" style="margin-top:10px;color:var(--mut)">Nessuna seduta.</div>
  <div class="row" style="margin-top:10px">
   <button class="btn2" onclick="exportCSV()">ğŸ“¤ ESPORTA EXCEL</button>
   <button class="btn2" onclick="clearAll()">ğŸ—‘ï¸ SVUOTA</button>
  </div>
 </div>
 <button class="btn" onclick="go('form')">â• NUOVA SEDUTA</button>
</section>

<section id="form" class="hidden">
 <div class="card">
  <b>ğŸ§‘â€âš•ï¸ Dati seduta</b>
  <div class="grid" style="margin-top:10px">
   <div><label>ID paziente</label><input id="pid" placeholder="GR72"></div>
   <div><label>Firma infermiere</label><input id="firma" placeholder="Sigla / Nome"></div>
   <div><label>Accesso</label><select id="accesso"><option>FAV</option><option>AVG</option><option>CVC</option></select></div>
   <div><label>Puntura</label><select id="puntura"><option>Facile</option><option>Difficile</option><option>Impossibile</option></select></div>
   <div><label>Thrill</label><select id="thrill"><option>Normale</option><option>Ridotto</option><option>Assente</option></select></div>
  </div>
  <div class="row" style="margin-top:12px">
   <button class="btn2" onclick="go('home')">â†©ï¸ ANNULLA</button>
   <button class="btn" onclick="calcola()">âš™ï¸ CALCOLA</button>
  </div>
 </div>
</section>

<section id="result" class="hidden">
 <div class="card">
  <b>ğŸ“Š Esito</b>
  <span id="badge" class="badge g0">G0</span>
  <div id="alertMedico" class="alert red siren hidden">
   ğŸš¨ COMUNICARE IMMEDIATAMENTE AL MEDICO ğŸš¨
  </div>
  <div id="medicoBox" class="hidden" style="margin-top:10px">
   <label>ğŸ‘¨â€âš•ï¸ Medico informato</label>
   <select id="medicoInf"><option></option><option>SÃ¬</option><option>No</option></select>
  </div>
 </div>
 <div class="row">
  <button class="btn2" onclick="go('form')">âœï¸ MODIFICA</button>
  <button class="btn" onclick="salva()">ğŸ’¾ SALVA</button>
 </div>
</section>

</main>
</div>

<script>
if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js')}
const KEY="vashd_fap_sessions_v5";

function enterApp(){
 document.getElementById('splash').style.display='none';
 document.getElementById('app').classList.remove('hidden');
}

function go(id){
 ['home','form','result'].forEach(s=>document.getElementById(s).classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
}

function alertHaptic(g){
 if(navigator.vibrate){navigator.vibrate(g===3?[200,80,200,80,400]:[150,80,150]);return;}
 document.body.classList.add('flash');
 setTimeout(()=>document.body.classList.remove('flash'),700);
}

function calcola(){
 let g=0;
 if(thrill.value==='Assente'||puntura.value==='Impossibile') g=3;
 badge.className='badge g'+g; badge.textContent='G'+g;
 const need=g>=2;
 alertMedico.classList.toggle('hidden',!need);
 medicoBox.classList.toggle('hidden',!need);
 window.lastGrade=g;
 if(need) alertHaptic(g);
 go('result');
}

function salva(){
 if(!pid.value||!firma.value){alert('Completa i dati');return;}
 if(lastGrade>=2 && medicoInf.value!=='SÃ¬'){alert('Devi informare il medico');return;}
 const s=JSON.parse(localStorage.getItem(KEY)||"[]");
 s.push({ts:Date.now(),id:pid.value,grade:lastGrade,firma:firma.value,medico:medicoInf.value});
 localStorage.setItem(KEY,JSON.stringify(s));
 render(); go('home');
}

function render(){
 const h=document.getElementById('history');
 const s=JSON.parse(localStorage.getItem(KEY)||"[]");
 h.innerHTML=s.length?s.slice().reverse().map(e=>`${new Date(e.ts).toLocaleString()} â€¢ ${e.id} â€¢ G${e.grade}`).join('<br>'):"Nessuna seduta.";
}

function clearAll(){if(confirm('Svuotare tutto?')){localStorage.removeItem(KEY);render();}}

function exportCSV(){
 const s=JSON.parse(localStorage.getItem(KEY)||"[]");
 if(!s.length)return alert('Nessun dato');
 let csv="Data;ID;Grading;Infermiere;Medico\n"+s.map(e=>`${new Date(e.ts).toLocaleString()};${e.id};G${e.grade};${e.firma};${e.medico}`).join("\n");
 const a=document.createElement('a');
 a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
 a.download='VAS-HD_sedute.csv'; a.click();
}

render();
</script>

</body>
</html>
